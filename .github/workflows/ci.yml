# æ–‡ä»¶è·¯å¾„ï¼š.github/workflows/ci.yml
# åŠŸèƒ½ï¼šç»“åˆ TurboRepo + Changesets å®ç°è‡ªåŠ¨å®‰è£…ä¾èµ–ã€æ„å»ºã€æµ‹è¯•ã€å¹¶åœ¨ release åˆ†æ”¯åˆå¹¶æ—¶è‡ªåŠ¨å‘å¸ƒåˆ° npm

name: CI

# ğŸ‘‡ è§¦å‘æ¡ä»¶ï¼šå½“ push æˆ– pull request åˆ° release åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [release]
  pull_request:
    branches: [release]

jobs:
  install-and-test:
    # ğŸ‘‡ ä½¿ç”¨æœ€æ–°ç‰ˆ Ubuntu è¿è¡Œä»»åŠ¡
    runs-on: ubuntu-latest

    steps:
      # ğŸ‘‡ ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸ‘‡ ç¬¬äºŒæ­¥ï¼šè®¾ç½® pnpm ç¯å¢ƒï¼ˆä½¿ç”¨ v8ï¼‰
      - name: Set up pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # ğŸ‘‡ ç¬¬ä¸‰æ­¥ï¼šå®‰è£…ä¾èµ–ï¼ˆæ”¯æŒ Monorepoï¼‰
      - name: Install dependencies
        run: pnpm install

      # ğŸ‘‡ ç¬¬å››æ­¥ï¼šæ‰§è¡Œ lintã€testã€buildï¼Œè·³è¿‡ä¸å­˜åœ¨çš„ test è„šæœ¬
      - name: Run lint, test, build
        run: |
          pnpm turbo run lint --continue --if-present
          pnpm turbo run test --continue --if-present
          pnpm turbo run build --continue --if-present
  release:
    # ğŸ‘‡ ä»…åœ¨ install-and-test æˆåŠŸåæ‰§è¡Œ
    needs: install-and-test
    runs-on: ubuntu-latest

    # ğŸ‘‡ é™å®šä»…åœ¨ release åˆ†æ”¯æ‰§è¡Œå‘å¸ƒä»»åŠ¡
    if: github.ref == 'refs/heads/release'

    steps:
      # ğŸ‘‡ åŒæ ·æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸ‘‡ è®¾ç½® pnpm ç¯å¢ƒ
      - name: Set up pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # ğŸ‘‡ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install

      # ğŸ‘‡ ä½¿ç”¨ Changesets è¿›è¡Œç‰ˆæœ¬ bump æˆ–è‡ªåŠ¨å‘å¸ƒ
      - name: Create release Pull Request or Publish to npm
        uses: changesets/action@v1
        with:
          publish: pnpm release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # å†…ç½® GitHub Token ç”¨äºæäº¤ PR
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}         # ä½ åœ¨ GitHub è®¾ç½®ä¸­çš„ NPM Tokenï¼ˆç”¨äº npm publishï¼‰